<!DOCTYPE html>
<html>

<head>
  <title>Conway's Game of Life</title>
  <style>
    .grid {
      margin: 1em auto;
      border: 1px solid #ccc
    }

    .grid td {
      cursor: pointer;
      width: 30px;
      height: 30px;
      text-align: center;
      font-family: sans-serif;
      font-size: 13px
    }

    .grid td.alive {
      background-color: black;
    }
  </style>
</head>

<body onload="CreateGrid()">
  <script>

  
  
  // String to hold data to fill the grid.
  var gridString = "0000000000000000000000000" +
                   "0000000000000000000000000" +
                   "0000000000000000000000000" +
                   "0000000000000000000000000";
				   
  var response;
  
  //getting data repeatedly from the db
  function retrieve(){
   var xhttp = new XMLHttpRequest();
	  
	  //window.alert("test1");
	 // console.log("in ClickedCell");
     // xmlhttp.open("GET", "sendData.php?r=" + (row + 1) + "&c=" + (col + 1), true);
     // xmlhttp.send();
	  xhttp.open("POST", "retrieveData.php", true); //get updates from onclick event to send to php,

	//xhttp.setRequestHeader('Cache-Control', 'no-cache');
	//xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
	//pass to php the updated string.

		xhttp.onreadystatechange = function() {
			if (xhttp.readyState == 4 && xhttp.status == 200) {
			 //document.getElementById("ClickedCell").innerHTML = this.responseText;
			// document.write("this.responseText"); 
			 //returns the response as a string, set it as a variable to then be seen in html
			response = xhttp.responseText;
		
			 console.log("response: " + response);
			}
		  };
	
		xhttp.send(null);
		// 
		//var params = 'r=1&c=1'
		//xhttp.send(params);
	 //window.setInterval(retrieve, 5000) 
	 windows.setTimeout(retrieve, 1000);
	}	
		
	retrieve();	
	
  
  
  function CreateGrid() {
  // Skip the first 13 elements in string. Then read 10 and skip 2 until
  // full grid is read. Last element read will be 130 out of the 144 total char.
    //var lastClicked;
    var grid = clickableGrid(10, 10, function(el, row, col) {
      console.log("You clicked on element:", el);
      console.log("You clicked on row:", row);
      console.log("You clicked on col:", col);

      // Checks if the cell is already alive.
      // If not, then sends the element, row and cell to ClickedCell func.
      if (el.className != 'alive') {
        ClickedCell(el, row, col);
      }

    });

    document.body.appendChild(grid);

    function clickableGrid(rows, cols, callback) {
    var i = 0;
    var grid = document.createElement('table');
    grid.className = 'grid';
    for (var r = 0; r < rows; ++r) {
      var tr = grid.appendChild(document.createElement('tr'));
      for (var c = 0; c < cols; ++c) {
        var cell = tr.appendChild(document.createElement('td'));
        // Comment out below once code it working to fill in the database
        cell.innerHTML = i;
        // Added an id to each element so it can be located to set className.
        cell.id = i;
        i++;
        cell.addEventListener('click', (function(el, r, c) {
          return function() {
            callback(el, r, c);
          }
        })(cell, r, c), false);
      }
    }

    return grid;
    }

    // Remove next row once AJAX is working
    gridString = "01001000000101000101111001100011111010010001000110" +
                 "11010100100010010111000000011111111110000001111000";
    // Want this to run everytime we get a response from the AJAX with a new string.
    // Will set gridString = to the response
    FillInGrid(gridString);

    // Function called everytime a dead cell is clicked to send that row and col
    // to the php to update the database.
    function ClickedCell(el, row, col) {
      el.className = 'alive';
      // POST the row as r and col as c here
      // Send row and column incremented by 1

      var xhttp = new XMLHttpRequest();
	  
	  //window.alert("test1");
	  console.log("in ClickedCell");
     // xmlhttp.open("GET", "sendData.php?r=" + (row + 1) + "&c=" + (col + 1), true);
     // xmlhttp.send();
	  xhttp.open("POST", "sendData.php", true); //get updates from onclick event to send to php,

	//xhttp.setRequestHeader('Cache-Control', 'no-cache');
	xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
	//pass to php the updated string.

		xhttp.onreadystatechange = function() {
			if (xhttp.readyState == 4 && xhttp.status == 200) {
			 //document.getElementById("ClickedCell").innerHTML = this.responseText;
			// document.write("this.responseText"); 
			 //returns the response as a string, set it as a variable to then be seen in html
			 
			}
		  };
	
		xhttp.send( "r=" + (row + 1)+ "&c=" + (col + 1));
		// 
		//var params = 'r=1&c=1'
		//xhttp.send(params);
	  
		var response = xhttp.responseText;
    }


    // The original 144 character string returned by the table will be parsed
    // down to the 100 character string to match the displayed table before
    // sending to Javascript.
    // 100 character string will be passed in to fill in the grid
    function FillInGrid(table) {
      // Holds the string that is passed to the function that corresponds to
      // the table.
      var string = table;

      // Loops through every character in the string and verifies it is alive.
      // If character is alive, it will be a 1 and will correspond with the id
      // of the cell. It then sets that cells className to 'alive.
      // If it's not alive, it will change the className to ''.
      for (var i = 0; i < string.length; i++) {
        if (string.substr(i,1) == 1) {
          document.getElementById(i).className = 'alive';
        }
        else {
          document.getElementById(i).className = '';
        }
      }
    }
  }

  </script>
</body>


</html>